{{extend 'layout.html'}}

{{block head}}
<!-- Anything in this block will be added
     to the html head section of the page. -->
{{end}}

<!--
     # In the view
     #
     # Row headers: student names
     # Column headers: day of the month
     #                 weekday abbreviation
     #
     # for each student
     #   for each day of the month:
     #     if it is a non-attendance day:
     #       display as "greyed out", no checkbox
     #     else:
     #       display checkbox
     #       if present:
     #         checkbox=checked
     #       else:
     #         checkbox=unchecked

     Is it possible to have a table header that stays fixed while things scroll under it?
     Like frozen rows in Excel.
     I doubt it.
   -->

<h1>{{=date_header}} Attendance</h1>

<div class="row">
    <div class="col-sm-2">
        <select id="attendance_month" class="generic-widget form-control">
            {{for month in menu_months:}}
            <option value="{{=month}}"
                    {{if month == date_header:}}selected{{pass}}>{{=month}}</option>
            {{pass}}
        </select>
    </div>
</div>

<div class="row">
    <div class="col-sm-12">

        <table class="table table-striped">

            <!--
                 I can probably add column highlighting with a
                 colgroup and a class, and maybe some javascript.
            -->

            <thead>
                <tr>
                    <th>Student</th>
                    {{for date in sorted(class_days.keys()):}}
                    <th>{{=date.day}}<br>{{=class_days[date][0]}}</th>
                    {{pass}}
                </tr>
            </thead>

            <tbody>
                {{ordered_class_day_list = sorted(class_days.keys())}}

                {{for student in sorted(class_list.keys()):}}
                {{student_id = class_list[student]}}
                <tr>

                    <td>
                        {{=student}}
                    </td>

                    {{for class_day in ordered_class_day_list:}}
                    {{attendance_record_id, student_present = attendance[student_id][class_day]}}
                    <td>
                        <input type="checkbox" class="attendance-checkbox"
                               id="{{=attendance_record_id}},{{=class_day}},{{=student_id}},{{=class_id}}"
                               {{ if student_present:}}
                               checked="checked"
                               {{pass}}
                        />
                    </td>
                    {{pass}}

                </tr>
                {{pass}}
            </tbody>

        </table>
    </div>
</div>

{{block page_js}}
<script>
 $(document).ready(function() {
     $(".attendance-checkbox").change(function() {
         var id_bits = this.id.split(",");
         var new_attendance_data = {
             attendance_id: id_bits[0],
             class_day: id_bits[1],
             student_id: id_bits[2],
             class_id: id_bits[3],
             present: this.checked
         };

         $.ajax({
             url: "{{=URL('attendance', 'save_attendance_info')}}",
             dataType: "json",
             type: "POST",
             data: {"data": new_attendance_data},
             success: function(data) {
                 /* This space intentionally left blank. */
             },
             error: function(jqxhr, status, error) {
                 alert("Status: " + status + "\nError: " + error);
             }
         });
     });
 });
</script>

{{end}}
