{{extend 'layout.html'}}

{{block head}}
<!-- Anything in this block will be added
     to the html head section of the page. -->
<link rel="stylesheet" media="screen" href="{{=URL('static', 'js/dist/handsontable.full.css')}}">
{{end}}

<div class="row">
    <div class="col-sm-12">
        <h1 class="class-name">{{=class_name}}</h1>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
       <button type="button" class="btn btn-default btn-xs" onclick="window.location.href='{{=URL('grades', 'create', args = [class_id,auth.user_id])}}'">Create a new Assignment
            
        </button>
    </div>
    
</div>
<div class="row">
    <div class="col-sm-12">
        <form>
            <div class="row options-row">
                <div class="col-sm-12">
                    Filter by stanadard: 
                    <select id="standards-menu">
                        <option value="-1">All</option>
                        {{for standard in standards:}}
                        <option value="{{=standard.id}}">{{=standard.reference_number}}</option>
                        {{pass}}
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div id="student_grades" class="dataTable hot-scrollable"></div>
                </div>
            </div>
        </form>
    </div>
</div>

{{block page_js}}

<script src="{{=URL('static', 'js/dist/handsontable.full.js')}}"></script>
<script type="text/javascript">

 // Data binding as a reference.
 // When you change the data, you can update the view by rendering it.
 // http://docs.handsontable.com/0.20.0/tutorial-data-binding.html

 var testRenderer = function(instance, td, row, col, prop, value, cellProperties) {
     Handsontable.renderers.NumericRenderer.apply(this, arguments);
     if ((col > 0) && (row > 2)) {
         new_value = parseFloat(value);
         max_score = instance.getDataAtCell(2, col);
         student_score = parseFloat(value);
         percent_score = student_score/max_score;
         
         if (percent_score == 0) {
             td.style.backgroundColor = '#cceeff'
         }
         else if (percent_score >= 0.90) {
             td.style.backgroundColor = '#ccffcc' // These can probably be changed to use a css class.
         }
         else if ((percent_score < 0.90) && (percent_score >= 0.70)) {
             td.style.backgroundColor = '#ffffcc' // These can probably be changed to use a css class.
         }
         else if (percent_score < 0.70) {
             td.style.backgroundColor = '#ff9999' // These can probably be changed to use a css class.
         }
     }
 };
 
 var container = document.getElementById("student_grades");
 var hot = undefined;
 var table_data = [];
 var options = {
     minSpareRows: 0,
     fixedColumnsLeft: 1,
     colWidths: 150,
     colHeaders: false,
     rowHeaders: false,
     contextMenu: true,
     //allowInvalid: false,
     afterChange: function(change, source) {
         if(source === "loadData") {
             return;
         }
         $.ajax({
             url: "{{=URL('classes', 'save_student_grades', args=[class_id])}}",
             dataType: "json",
             type: "POST",
             data: {"data": hot.getData().slice(3)},
             success: function(data) {
                 // We might do something with this later.
             },
             error: function(jqxhr, status, error) {
                 alert("Status: " + status + "\nError: " + error);
             }
         });
     }
 };
 
 function set_visible_columns(row) {
     var columns = [];
     for(var i = 1; i < row.length; i += 2) {
         columns.push({data: i});
     }
     return columns;
 }


 function set_table(data) {
     table_data = data;
     options.data = table_data;
     options.renderer = testRenderer;
     options.columns = set_visible_columns(table_data[0]);
 }

 function load_data(class_id, standard_id) {
     var url = "{{=URL('classes', 'student_grades')}}/" + class_id;

     if (standard_id !== "-1") {
         url += "/" + standard_id;
     }

     $.ajax({
         url: url,
         dataType: "json",
         type: "GET",
         success: function(data) {
             set_table(data);
             hot = new Handsontable(container, options);
         },
         error: function(jqxhr, status, error) {
             alert("Status: " + status + "\nError: " + error);
         }
     });
 }
 
 $("select#standards-menu").change(function() {
     load_data({{=class_id}}, $(this).val());
 });
 
 load_data({{=class_id}}, $("select#standards-menu option:selected").val());

</script>

{{end}}
